<!DOCTYPE html>
<html>
<head>
  <title>Video Chat</title>
  <style>
    body { font-family: Arial; text-align: center; margin-top: 20px; }
    video { width: 45%; margin: 10px; background: black; }
    #roomPrompt { display: none; }
  </style>
<link rel="stylesheet" href="styles.css">
</head>
<body>

<h2>Chit-chat Video Chat</h2>

<div id="error" style="color:red;"></div>

<div id="roomPrompt">
  <p>Enter a room name:</p>
  <input id="roomInput" type="text">
  <button onclick="joinRoom()">Join</button>
</div>

<div id="videos" style="display:none;">
  <video id="localVideo" autoplay playsinline muted></video>
  <video id="remoteVideo" autoplay playsinline></video>
</div>

<script>
let ws;
let pc;
let localStream;
let roomName = "";

async function init() {
  try {
    localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    document.getElementById("roomPrompt").style.display = "block";
  } catch (err) {
    document.getElementById("error").innerText = "Camera and microphone access is required.";
  }
}
init();

function joinRoom() {
  const input = document.getElementById("roomInput").value.trim();
  if (!input) {
    alert("Enter a valid room name.");
    return;
  }
  roomName = input;
  
  ws = new WebSocket("ws://" + window.location.host);
  ws.onopen = () => {
    ws.send(JSON.stringify({ type: "join", room: roomName }));
  };

  ws.onmessage = async (msg) => {
    const data = JSON.parse(msg.data);

    if (data.type === "room_full") {
      alert("Room is full.");
      return;
    }

    if (data.type === "joined") {
      setupRTC();
    }

    if (data.type === "ready") {
      makeOffer();
    }

    if (data.type === "signal") {
      if (data.offer) {
        await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        ws.send(JSON.stringify({ type: "signal", room: roomName, answer }));
      }

      if (data.answer) {
        await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
      }

      if (data.ice) {
        try {
          await pc.addIceCandidate(data.ice);
        } catch {}
      }
    }
  };
}

function setupRTC() {
  pc = new RTCPeerConnection();

  localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

  pc.ontrack = (e) => {
    document.getElementById("remoteVideo").srcObject = e.streams[0];
  };

  pc.onicecandidate = (e) => {
    if (e.candidate) {
      ws.send(JSON.stringify({ type: "signal", room: roomName, ice: e.candidate }));
    }
  };

  document.getElementById("localVideo").srcObject = localStream;
  document.getElementById("videos").style.display = "block";
}

async function makeOffer() {
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  ws.send(JSON.stringify({ type: "signal", room: roomName, offer }));
}
</script>

</body>
</html>
